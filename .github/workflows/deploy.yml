name: ğŸš€ Deploy HotelOS to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    name: ğŸ“¦ FTP Sync to MilesWeb
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ˜ Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, intl, pdo_mysql
          coverage: none

      - name: ğŸ“¦ Install Dependencies
        run: composer install --no-dev --optimize-autoloader --prefer-dist

      - name: ğŸ”§ Install lftp
        run: sudo apt-get update && sudo apt-get install -y lftp
      
      - name: ğŸ”„ Deploy via LFTP Mirror
        env:
          FTP_SERVER: ${{ secrets.FTP_SERVER }}
          FTP_USERNAME: ${{ secrets.FTP_USERNAME }}
          FTP_PASSWORD: ${{ secrets.FTP_PASSWORD }}
        run: |
          # Robust LFTP Command using -c (avoids sed/file issues with special chars)
          lftp -c "
          set ftp:ssl-allow yes;
          set ftp:ssl-force no;
          set ssl:verify-certificate no;
          set ssl:check-hostname no;
          set ftp:passive-mode yes;
          set net:timeout 300;
          set net:max-retries 20;
          set net:reconnect-interval-base 5;
          set net:connection-limit 1;
          
          open -u '$FTP_USERNAME','$FTP_PASSWORD' '$FTP_SERVER';
          
          mirror --reverse --verbose --parallel=1 --no-perms \
            --exclude-glob .git* \
            --exclude-glob .github/ \
            --exclude-glob *.md \
            --exclude-glob database/ \
            --exclude-glob .vscode/ \
            --exclude-glob .idea/ \
            --exclude-glob node_modules/ \
            --exclude-glob .ftp-deploy-sync-state.json \
            --exclude-glob .env \
            --exclude-glob .env.* \
            --exclude-glob public/uploads/ \
            --exclude-glob logs/ \
            . .;
          bye;
          "
      
      - name: âœ… Deployment Complete
        run: |
          echo "========================================="
          echo "ğŸ‰ HotelOS Deployed Successfully!"
          echo "ğŸŒ URL: https://hotelos.needkit.in"
          echo "ğŸ“… Time: $(TZ='Asia/Kolkata' date)"
          echo "========================================="
