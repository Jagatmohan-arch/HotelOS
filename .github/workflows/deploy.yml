name: ğŸš€ Deploy HotelOS to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    name: ğŸ“¦ FTP Sync to MilesWeb
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ˜ Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, intl, pdo_mysql
          coverage: none

      - name: ğŸ“¦ Install Dependencies
        run: composer install --no-dev --optimize-autoloader --prefer-dist

      - name: ğŸ“¦ Install LFTP
        run: sudo apt-get install -y lftp

      - name: ğŸ“‚ Sync Files (LFTP)
        env:
          FTP_SERVER: ${{ secrets.FTP_SERVER }}
          FTP_USERNAME: ${{ secrets.FTP_USERNAME }}
          FTP_PASSWORD: ${{ secrets.FTP_PASSWORD }}
        run: |
          lftp -e "set ftp:ssl-allow no; set net:timeout 20; set net:max-retries 3; mirror -R -v --parallel=2 --exclude-glob .git* --exclude-glob .github* --exclude-glob tests* --exclude-glob node_modules* --exclude .env --exclude .env.example --exclude composer.lock ./ /public_html/; quit" -u "$FTP_USERNAME","$FTP_PASSWORD" "$FTP_SERVER"

      - name: âœ… Deployment Complete
        run: |
          echo "========================================="
          echo "ğŸ‰ HotelOS Deployment Triggered"
          echo "ğŸŒ URL: https://hotelos.needkit.in"
          echo "========================================="
