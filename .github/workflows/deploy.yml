name: ðŸš€ Deploy HotelOS to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    name: ðŸ“¦ FTP Sync to MilesWeb
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ðŸ”§ Install lftp
        run: sudo apt-get update && sudo apt-get install -y lftp
      
      - name: ðŸ”„ Deploy via LFTP Mirror
        env:
          FTP_SERVER: ${{ secrets.FTP_SERVER }}
          FTP_USERNAME: ${{ secrets.FTP_USERNAME }}
          FTP_PASSWORD: ${{ secrets.FTP_PASSWORD }}
        run: |
          # Create lftp script
          cat > deploy.lftp << 'SCRIPT'
          set ftp:ssl-allow yes
          set ftp:ssl-force no
          set ssl:verify-certificate no
          set ssl:check-hostname no
          set ftp:passive-mode yes
          set net:timeout 120
          set net:max-retries 10
          set net:reconnect-interval-base 10
          set net:connection-limit 1
          set net:limit-rate 0
          
          # Connect to server
          open -u $FTP_USERNAME,$FTP_PASSWORD $FTP_SERVER
          
          # Mirror local to remote (upload only changes)
          # parallel=1, no-delete for maximum reliability
          mirror --reverse --verbose --parallel=1 --no-perms \
            --exclude-glob .git* \
            --exclude-glob .github/ \
            --exclude-glob *.md \
            --exclude-glob database/ \
            --exclude-glob .vscode/ \
            --exclude-glob .idea/ \
            --exclude-glob node_modules/ \
            --exclude-glob .ftp-deploy-sync-state.json \
            --exclude-glob .env \
            --exclude-glob .env.* \
            --exclude-glob public/uploads/ \
            --exclude-glob logs/ \
            . .
          
          bye
          SCRIPT
          
          # Replace env vars in script
          sed -i "s|\$FTP_USERNAME|${FTP_USERNAME}|g" deploy.lftp
          sed -i "s|\$FTP_PASSWORD|${FTP_PASSWORD}|g" deploy.lftp
          sed -i "s|\$FTP_SERVER|${FTP_SERVER}|g" deploy.lftp
          
          # Execute deployment
          lftp -f deploy.lftp
          
          # Cleanup
          rm deploy.lftp
      
      - name: âœ… Deployment Complete
        run: |
          echo "========================================="
          echo "ðŸŽ‰ HotelOS Deployed Successfully!"
          echo "ðŸŒ URL: https://hotelos.needkit.in"
          echo "ðŸ“… Time: $(TZ='Asia/Kolkata' date)"
          echo "========================================="
