name: üöÄ Deploy HotelOS to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    name: üì¶ FTP Sync to MilesWeb
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: üîß Install lftp
        run: sudo apt-get update && sudo apt-get install -y lftp
      
      - name: üîÑ Deploy via LFTP Mirror
        env:
          FTP_SERVER: ${{ secrets.FTP_SERVER }}
          FTP_USERNAME: ${{ secrets.FTP_USERNAME }}
          FTP_PASSWORD: ${{ secrets.FTP_PASSWORD }}
        run: |
          # Robust LFTP Command using -c (avoids sed/file issues with special chars)
          lftp -c "
          set ftp:ssl-allow yes;
          set ftp:ssl-force no;
          set ssl:verify-certificate no;
          set ssl:check-hostname no;
          set ftp:passive-mode yes;
          set net:timeout 300;
          set net:max-retries 20;
          set net:reconnect-interval-base 5;
          set net:connection-limit 1;
          
          open -u '$FTP_USERNAME','$FTP_PASSWORD' '$FTP_SERVER';
          
          mirror --reverse --verbose --parallel=1 --no-perms \
            --exclude-glob .git* \
            --exclude-glob .github/ \
            --exclude-glob *.md \
            --exclude-glob database/ \
            --exclude-glob .vscode/ \
            --exclude-glob .idea/ \
            --exclude-glob node_modules/ \
            --exclude-glob .ftp-deploy-sync-state.json \
            --exclude-glob .env \
            --exclude-glob .env.* \
            --exclude-glob public/uploads/ \
            --exclude-glob logs/ \
            . .;
          bye;
          "
      
      - name: ‚úÖ Deployment Complete
        run: |
          echo "========================================="
          echo "üéâ HotelOS Deployed Successfully!"
          echo "üåê URL: https://hotelos.needkit.in"
          echo "üìÖ Time: $(TZ='Asia/Kolkata' date)"
          echo "========================================="
